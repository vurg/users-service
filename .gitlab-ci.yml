image: docker:latest

stages:
  - build
  - test

services:
  - docker:dind

variables:
  NEWMAN_IMAGE: postman/newman:latest
  POSTMAN_COLLECTION_FILE: UserServiceCI.postman_collection.json

# before_script:
#    # Install Docker Compose
#   - apk add --update py-pip &&
#     pip install docker-compose

build_job:
  tags:
    - docker-build
  stage: build
  script:
    - docker-compose build

test_job:
  tags:
    - docker-build
  stage: test
  script:
    - docker-compose up -d
    - sleep 5
    - docker compose restart web
    - docker-compose run web python manage.py migrate
    - sleep 5
    - echo $HOST_IP
    - cat $POSTMAN_COLLECTION_FILE
    - docker run --rm -v $(pwd):/etc/newman -w /etc/newman $NEWMAN_IMAGE run $POSTMAN_COLLECTION_FILE --env-var host_ip=$HOST_IP
