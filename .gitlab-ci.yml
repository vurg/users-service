image: docker:latest

stages:
  - build
  - test

services:
  - docker:dind

variables:
  NEWMAN_IMAGE: postman/newman:latest
  POSTMAN_COLLECTION_FILE: UserServiceCI.postman_collection.json

# before_script:
#    # Install Docker Compose
#   - apk add --update py-pip &&
#     pip install docker-compose

build_job:
  tags:
    - docker-build
  stage: build
  script:
    - docker-compose build
    - docker-compose up -d

connection_job:
  tags:
    - shell
  stage: test
  script:
    - netstat -tuln
    - curl http://127.0.0.1:8000
    - telnet 127.0.0.1 8000


test_job:
  tags:
    - docker-build
  stage: test
  script:
    - docker network ls
    - sleep 5
    - docker compose restart web
    - docker-compose run web python manage.py migrate
    - sleep 5
    - docker run -d --network users-service_userservice --name proxy -p 8000:8000 alpine/socat tcp-listen:8000,fork,reuseaddr tcp-connect:web:8000
    - docker run --rm --network users-service_userservice -v $(pwd):/etc/newman -w /etc/newman $NEWMAN_IMAGE run $POSTMAN_COLLECTION_FILE
