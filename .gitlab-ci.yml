image: docker:latest

stages:
  - build
  - test

services:
  - docker:dind

variables:
  NEWMAN_IMAGE: postman/newman:latest
  POSTMAN_COLLECTION_FILE: UserServiceCI.postman_collection.json

# before_script:
#    # Install Docker Compose
#   - apk add --update py-pip &&
#     pip install docker-compose

build_job:
  tags:
    - docker-build
  stage: build
  script:
    - docker-compose build
    - docker-compose up -d

connection_job:
  tags:
    - shell
  stage: build
  script:
    - netstat -tuln
    - curl http://localhost:8000
    - telnet localhost 8000


test_job:
  tags:
    - docker-build
  stage: test
  script:
    - sleep 5
    - docker compose restart web
    - docker-compose run web python manage.py migrate
    - sleep 5
    - docker run --rm --network container:web -v $(pwd):/etc/newman -w /etc/newman $NEWMAN_IMAGE run $POSTMAN_COLLECTION_FILE
