image: docker:latest

stages:
  - build
  - test

services:
  - docker:dind

variables:
  NEWMAN_IMAGE: postman/newman:latest
  POSTMAN_COLLECTION_FILE: UserServiceCI.postman_collection.json

# before_script:
#    # Install Docker Compose
#   - apk add --update py-pip &&
#     pip install docker-compose

build_job:
  tags:
    - docker-build
  stage: build
  script:
    - docker-compose build
    - docker-compose up -d

test_job:
  tags:
    - docker-build
  stage: test
  script:
    - docker network ls
    - sleep 5
    - docker compose restart web
    - docker-compose run web python manage.py migrate
    - sleep 5
    - docker run --rm --network users-service_userservice -v $(pwd):/etc/newman -w /etc/newman $NEWMAN_IMAGE run host=web $POSTMAN_COLLECTION_FILE
